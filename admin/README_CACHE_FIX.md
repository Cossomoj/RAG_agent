# Исправление проблемы с очисткой кеша через админку

## Проблема

Через админку не чистится кеш в мини-приложении из-за хардкодных URL-адресов.

## Решение

### 1. Обновлена конфигурация админки

Добавлена поддержка переменных окружения для гибкой настройки URL-ов:

```python
# Конфигурация URL-ов через переменные окружения  
TELEGRAM_BOT_URL = os.getenv('TELEGRAM_BOT_URL', 'http://localhost:8007')
WEBAPP_URL = os.getenv('WEBAPP_URL', 'http://localhost:5000')
```

### 2. Настройка переменных окружения

Создайте файл `.env` в папке `admin/` со следующим содержимым:

#### Для локальной разработки:
```bash
TELEGRAM_BOT_URL=http://localhost:8007
WEBAPP_URL=http://localhost:5000
```

#### Для продакшн:
```bash
TELEGRAM_BOT_URL=http://213.171.25.85:8007
WEBAPP_URL=http://213.171.25.85:5000
```

### 3. Проверка работы

#### Шаг 1: Убедитесь что сервисы запущены
```bash
# Проверьте телеграм бот
curl http://localhost:8007/ping

# Проверьте мини-приложение  
curl http://localhost:5000/api/health
```

#### Шаг 2: Проверьте логи админки
При нажатии кнопки "Очистить кеш" в логах должно появиться:
```
[ADMIN] Очистка кешей: TELEGRAM_BOT_URL=http://localhost:8007, WEBAPP_URL=http://localhost:5000
```

#### Шаг 3: Проверьте ответ
Успешная очистка кеша должна вернуть:
```json
{
  "success": true,
  "message": "Кеши успешно очищены: телеграм-бот (успешно), веб-приложение (успешно)"
}
```

### 4. Диагностика проблем

#### Проблема: "не удается подключиться"
- **Причина**: Сервис недоступен по указанному URL
- **Решение**: 
  1. Проверьте, что сервис запущен
  2. Проверьте правильность URL в `.env`
  3. Попробуйте curl запрос вручную

#### Проблема: "HTTP ошибка 404"
- **Причина**: Неправильный endpoint
- **Решение**: Убедитесь, что используются правильные endpoints:
  - Телеграм бот: `/clear-cache`
  - Мини-приложение: `/api/clear-cache`

#### Проблема: "превышено время ожидания"
- **Причина**: Сервис работает медленно
- **Решение**: Увеличьте таймаут или проверьте нагрузку на сервер

### 5. Тестирование через API

Можно протестировать очистку кеша напрямую:

#### Очистка кеша телеграм бота:
```bash
curl -X POST http://localhost:8007/clear-cache
```

#### Очистка кеша мини-приложения:
```bash
curl -X POST http://localhost:5000/api/clear-cache
```

### 6. Мониторинг

Для мониторинга состояния кешей добавлены детальные логи:
- Какие URL используются для запросов
- Результат каждого запроса на очистку
- Детали ошибок при неудачных попытках

### 7. Дополнительные возможности

#### Очистка только кеша мини-приложения
Если нужно очистить только кеш мини-приложения, можно обратиться напрямую:
```bash
curl -X POST http://localhost:5000/api/clear-cache
```

#### Проверка статуса кешей
```bash
# Проверка здоровья мини-приложения
curl http://localhost:5000/api/health

# Проверка телеграм бота
curl http://localhost:8007/ping
```

## Результат

После этих изменений:
1. ✅ Админка корректно обращается к мини-приложению
2. ✅ Поддерживается как локальная разработка, так и продакшн
3. ✅ Добавлено подробное логирование для диагностики
4. ✅ Улучшена обработка ошибок
5. ✅ Кеш очищается в обеих системах одновременно 